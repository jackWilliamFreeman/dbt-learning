{{ config(database = "AA_OPERATIONS_MANAGEMENT") }}

SELECT
	sd.SHIFT,
	sd.SHIFT_DATE,
	sd.SHIFT_YEAR,
	sd.SHIFT_MONTH,
	OPERATION_NAME,
	e.EquipmentName AS  SOURCE_EQUIPMENT_NAME,
	e.ReportEquipmentName AS REPORTING_EQUIPMENT_NAME,
	ec.EquipmentClassName AS  SOURCE_EQUIPMENT_CLASS_NAME,
	ec.ReportEquipmentClassName AS REPORTING_EQUIPMENT_CLASS_NAME,
	eqt.EQUIPMENTTYPENAME AS  SOURCE_EQUIPMENT_TYPE_NAME,
	eqt.REPORTEQUIPMENTTYPENAME AS REPORTING_EQUIPMENT_TYPE_NAME,
	CYCLEID,
	SUM_UNCLASSIFIED_TIME,
	SUM_CALENDAR_TIME,
	SUM_AVAILABLE_TIME,
	SUM_DOWNTIME,
	SUM_UTILISED_TIME,
	SUM_UNSCHEDULED_MAINTENANCE,
	SUM_SCHEDULED_MAINTENANCE,
	SUM_STANDBY_TIME,
	SUM_PRODUCTIVE_TIME,
	SUM_OPERATING_STANDBY,
	SUM_EFFECTIVE_TIME,
	SUM_NON_EFFECTIVE_TIME,
	SUM_BREAKDOWN,
	SUM_ACCIDENT_DAMAGE,
	SUM_SCHED_SERVICE_BACKLOG,
	SUM_SURPLUS_UNAVAILABLE,
	SUM_MAJOR_SCHED_SERVICE_ONSITE,
	SUM_MAJOR_SCHED_SERVICE_OFFSITE,
	SUM_DURATION_SECONDS,
	ctu.RECORD_MODIFIED_DT,
	ECF_CLASS_ID,
	CONVERT_TIMEZONE('Australia/Perth',STARTTIME_UTC) AS STARTTIME_LOCAL ,
	CONVERT_TIMEZONE('Australia/Perth',ENDTIME_UTC) AS ENDTIME_LOCAL,
	CONVERT_TIMEZONE('UTC',STARTTIME_UTC) AS STARTTIME_UTC,
	CONVERT_TIMEZONE('UTC',ENDTIME_UTC) AS ENDTIME_UTC,
	JOBCODE,
	CREATIONMODE,
	VALIDATIONSEVERITY,
	PRIMARYMACHINE,
	PRIMARYMACHINENAME,
	PRIMARYMACHINECLASS,
	PRIMARYMACHINECLASSNAME,
	PRIMARYMACHINECATEGORY,
	PRIMARYMACHINECATEGORYNAME,
	SECONDARYMACHINE,
	SECONDARYMACHINENAME,
	SECONDARYMACHINECLASS,
	SECONDARYMACHINECLASSNAME,
	SECONDARYMACHINECATEGORY,
	SECONDARYMACHINECATEGORYNAME,
	PRIMARYOPERATOR,
	PRIMARYOPERATORNAME,
	SECONDARYOPERATOR,
	SECONDARYOPERATORNAME,
	ESTIMATEDFUELUSED,
	AVGBURNFUELUSED,
	MACHINEFUELCONSUMED,
	PREVIOUSCYCLE,
	ASSOCIATEDCYCLE,
	VALIDATION_MSG,
	SOURCE_COORD_X,
	SOURCE_COORD_Y,
	SOURCE_COORD_Z,
	SINK_COORD_X,
	SINK_COORD_Y,
	SINK_COORD_Z,
	END_SINK_COORD_X,
	END_SINK_COORD_Y,
	END_SINK_COORD_Z,
	DUMP_COORD_X,
	DUMP_COORD_Y,
	DUMP_COORD_Z,
	HASPREDICTEDROADS,
	AUTONOMOUS,
	HASDELAYS,
	CALCMATERIAL,
	CALCMATERIALNAME,
	DENSITY,
	DENSITYNAME,
	DENSITYTYPE,
	DIPPERCOUNT,
	DIPPERAVERAGESWINGTIME,
	ENDSMU,
	LOADERMATERIAL,
	LOADERMATERIALNAME,
	OPERMATERIAL,
	OPERMATERIALNAME,
	AUTOMATERIAL,
	AUTOMATERIALNAME,
	LOADINGTOOLMODE,
	LOADREPORTCOUNT,
	NOMINALPAYLOAD,
	PAYLOAD,
	REHANDLE,
	SOURCEBLOCK,
	SOURCEBLOCKLEVEL,
	SOURCEBLOCKNAME,
	SOURCELOCATION,
	SOURCELOCATIONNAME,
	STARTSMU,
	LOADTRAVDIST,
	MTTRAVDIST,
	LOADEDHORIZONTALDISTANCE,
	EMPTYHORIZONTALDISTANCE,
	LOADEDEFH,
	EMPTYEFH,
	LOADEDRISEDISTANCE,
	EMPTYRISEDISTANCE,
	LOADEDFALLDISTANCE,
	EMPTYFALLDISTANCE,
	LOADED_COASTING_EFHDIST,
	EMPTY_COASTING_EFHDIST,
	COASTING_TRAVEL_TIME,
	LOADEDTARGETTRAVELTIME,
	EMPTYTARGETTRAVELTIME,
	LOADEDEXPECTEDTRAVELTIME,
	EMPTYEXPECTEDTRAVELTIME,
	LOADEDACTUALTRAVELTIME,
	EMPTYACTUALTRAVELTIME,
	VIMSLOADEDSLOPEDISTANCE,
	VIMSEMPTYSLOPEDISTANCE,
	SINKBLOCK,
	SINKBLOCKNAME,
	SINKLOCATION,
	SINKLOCATIONNAME,
	PROCESSOR,
	PROCESSORCLASSNAME,
	PROCESSORNAME,
	ENDSINKBLOCK,
	ENDSINKBLOCKLEVEL,
	ENDSINKBLOCKNAME,
	ENDSINKLOCATION,
	ENDSINKLOCATIONNAME,
	TRANSMISSIONSHIFTS,
	ENDPROCESSOR,
	ENDPROCESSORCLASSNAME,
	ENDPROCESSORNAME,
	FUELUSED,
	FUELLEVEL,
	LASTBEACONDUMP,
	LASTBEACONDUMPNAME,
	LASTBEACONLOAD,
	LASTBEACONLOADNAME,
	LASTKNOWNMATERIAL,
	LASTKNOWNMATERIALNAME,
	ASSIGNEDSINKLOCATION,
	ASSIGNEDSINKLOCATIONNAME,
	OBSERVEDSINKLOCATION,
	OBSERVEDSINKLOCATIONNAME,
	ACTIVEBLEND,
	FREEDESTPERCENT_MAGNITUDE,
	FREEGRPDESTPERCENT_MAGNITUDE,
	SPILLCYCLE,
	GPSACCURACY,
	BI,
	JOB_ORDER_REF,
	ATTRIBUTEDCREW,
	CYCLE_SUBTYPE,
	ACTIVEDESTINATIONBLEND,
	LAST_MODIFIED,
	CREATED_DATE_UTC,
	JOBCODE_COMMENT
FROM
	{{ref('int_cycle_tum')}} ctu
INNER JOIN {{ref('stg_minestar_cycles')}} c ON
	c.CYCLE_OID = ctu.CYCLEID
	AND c.HUB = ctu.OPERATION_NAME
LEFT OUTER JOIN {{ref('stg_commontransform_shiftdates')}} sd
    ON
        ENDTIME_UTC >= sd.START_TIME AND ENDTIME_UTC <= sd.END_TIME
        AND sd.shift_date = dateadd(hour, -6, ENDTIME_UTC)::DATE -- Join Optimisation
INNER JOIN {{ref('stg_equipment')}} e ON
		e.Id = ctu.Equipment_Id
	AND e.ISDELETED = 0
INNER JOIN {{ref('stg_equipmentclass')}} ec ON
		ec.Id = e.EquipmentClassId
INNER JOIN {{ref('stg_equipmenttype')}} eqt ON
		eqt.ID = e.EQUIPMENTTYPEID