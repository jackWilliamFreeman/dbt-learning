{{ config(materialized='table') }}

WITH levels AS (
	SELECT
		TUL1.TIMEUSAGELEVELNAME AS L1,
		TUL1.ID AS L1_ID,
		TUL2.TIMEUSAGELEVELNAME AS L2,
		TUL2.ID AS L2_ID,
		TUL3.TIMEUSAGELEVELNAME AS L3,
		TUL3.ID AS L3_ID,
		TUL4.TIMEUSAGELEVELNAME AS L4,
		TUL4.ID AS L4_ID,
		TUL5.TIMEUSAGELEVELNAME AS L5,
		TUL5.ID AS L5_ID,
		TUL6.TIMEUSAGELEVELNAME AS L6,
		TUL6.ID AS L6_ID,
		TUL1.TIMEUSAGEVERSIONID,
		COALESCE(TUL6.ID, TUL5.ID, TUL4.ID, TUL3.ID, TUL2.ID, TUL1.ID) LEAF_ID
	FROM
		{{ ref('stg_timeusagelevel') }} TUL1
	LEFT OUTER JOIN {{ ref('stg_timeusagelevel') }} TUL2 ON
		TUL2.PARENTTIMEUSAGELEVELID = TUL1.ID
	LEFT OUTER JOIN {{ ref('stg_timeusagelevel') }} TUL3 ON
		TUL3.PARENTTIMEUSAGELEVELID = TUL2.ID
	LEFT OUTER JOIN {{ ref('stg_timeusagelevel') }} TUL4 ON
		TUL4.PARENTTIMEUSAGELEVELID = TUL3.ID
	LEFT OUTER JOIN {{ ref('stg_timeusagelevel') }} TUL5 ON
		TUL5.PARENTTIMEUSAGELEVELID = TUL4.ID
	LEFT OUTER JOIN {{ ref('stg_timeusagelevel') }} TUL6 ON
		TUL6.PARENTTIMEUSAGELEVELID = TUL5.ID
	WHERE
		TUL1.PARENTTIMEUSAGELEVELID  IS NULL
)
SELECT
		TETM.EVENTTYPEID ,
		C.L1,
		C.L2,
		C.L3,
		C.L4,
		C.L5,
		C.L6,
		ET.EVENTTYPENAME,
		CASE WHEN C.L1 = 'Calendar Time' THEN 1 ELSE 0 END AS IS_CALENDAR_TIME,
		CASE WHEN C.L2 = 'Available Time ' THEN 1 ELSE 0 END AS IS_AVAILABLE_TIME,
		CASE WHEN C.L2 = 'Downtime' THEN 1 ELSE 0 END AS IS_DOWNTIME,
		CASE WHEN C.L3 = 'Utilised Time' THEN 1 ELSE 0 END AS IS_UTILISED_TIME,
		CASE WHEN C.L3 = 'Unscheduled Maintenance' THEN 1 ELSE 0 END AS IS_UNSCHEDULED_MAINTENANCE,
		CASE WHEN C.L3 = 'Scheduled Maintenance' THEN 1 ELSE 0 END AS IS_SCHEDULED_MAINTENANCE,
		CASE WHEN C.L3 = 'Standby Time' THEN 1 ELSE 0 END AS IS_STANDBY_TIME,
		CASE WHEN C.L4 = 'Productive Time' THEN 1 ELSE 0 END AS IS_PRODUCTIVE_TIME,
		CASE WHEN C.L4 = 'Operating Standby' THEN 1 ELSE 0 END AS IS_OPERATING_STANDBY,
		CASE WHEN C.L4 = 'External Standby' THEN 1 ELSE 0 END AS IS_EXTERNAL_STANDBY,
		CASE WHEN C.L4 = 'Operating Delay' THEN 1 ELSE 0 END AS IS_OPERATING_DELAY,
		CASE WHEN C.L5 = 'Effective Time' THEN 1 ELSE 0 END AS IS_EFFECTIVE_TIME,
		CASE WHEN C.L5 = 'Non-Effective Time' THEN 1 ELSE 0 END AS IS_NON_EFFECTIVE_TIME,
		CASE WHEN ET.EVENTTYPENAME = 'Breakdown' THEN 1 ELSE 0 END AS IS_BREAKDOWN,
		CASE WHEN ET.EVENTTYPENAME = 'Accident Damage' THEN 1 ELSE 0 END AS IS_ACCIDENT_DAMAGE,
		CASE WHEN ET.EVENTTYPENAME = 'Scheduled Service and Backlog' THEN 1 ELSE 0 END AS IS_SCHED_SERVICE_BACKLOG,
		CASE WHEN ET.EVENTTYPENAME = 'Surplus Unavailable' THEN 1 ELSE 0 END AS IS_SURPLUS_UNAVAILABLE,
		CASE WHEN ET.EVENTTYPENAME = 'Major Scheduled Maintenance (onsite)' THEN 1 ELSE 0 END AS IS_MAJOR_SCHED_SERVICE_ONSITE,
		CASE WHEN ET.EVENTTYPENAME = 'Major Scheduled Maintenance (Offsite)' THEN 1 ELSE 0 END AS IS_MAJOR_SCHED_SERVICE_OFFSITE,
		C.TIMEUSAGEVERSIONID
	FROM
		 {{ ref('stg_tumeventtypemapping') }} TETM
	LEFT OUTER JOIN levels C ON
		TETM.TIMEUSAGELEVELID = C.LEAF_ID
	LEFT OUTER JOIN {{ ref('stg_eventtype') }} ET ON ET.ID = TETM.EVENTTYPEID

